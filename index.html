<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Esc√°ner de Albaranes ¬∑ Licor 43</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --card: #0b1223cc; /* glass */
        --text: #e5e7eb; /* gray-200 */
        --muted: #94a3b8; /* slate-400 */
        --brand: #f59e0b; /* amber-500 */
        --brand-2: #fde047; /* amber-300 */
        --ok: #10b981; /* emerald-500 */
        --err: #ef4444; /* red-500 */
        --ring: #22d3ee; /* cyan-400 */
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 90% -10%,
            #1e293b 10%,
            transparent 60%
          ),
          radial-gradient(900px 500px at -10% 20%, #111827 10%, transparent 60%),
          linear-gradient(180deg, #020617, #0b1223 60%, #0f172a);
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .wrap {
        width: min(100%, 980px);
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr;
      }
      header {
        display: flex;
        align-items: center;
        gap: 14px;
        justify-content: center;
      }
      .logo {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: url("logo_licor43.jpeg") center/cover no-repeat, #111827;
        box-shadow: 0 0 0 2px #ffffff22 inset, 0 10px 30px #0006;
        flex: none;
      }
      h1 {
        margin: 0;
        font-size: clamp(1.15rem, 2.5vw, 1.5rem);
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #fff;
      }

      .card {
        background: var(--card);
        backdrop-filter: blur(8px) saturate(120%);
        border: 1px solid #ffffff1f;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 30px #0006;
      }

      .grid {
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 1px solid #ffffff26;
        border-radius: 999px;
        background: #ffffff14;
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
      }
      .pill b {
        color: var(--brand-2);
      }
      .hint {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .dz {
        position: relative;
        display: grid;
        place-items: center;
        gap: 10px;
        text-align: center;
        border: 1.5px dashed #ffffff33;
        border-radius: 16px;
        padding: 22px;
        background: #0b122366;
        transition: all 0.15s ease;
        outline: none;
      }
      .dz.drag {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px #22d3ee55;
      }
      .dz input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }
      .dz .cta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        appearance: none;
        border: 0;
        border-radius: 12px;
        padding: 12px 16px;
        color: #0b1223;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(180deg, var(--brand), var(--brand-2));
        box-shadow: 0 8px 20px #f59e0b3a;
        transition: transform 0.08s ease, box-shadow 0.15s ease,
          filter 0.2s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(0.1);
      }
      .btn.sec {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #ffffff24;
        box-shadow: none;
      }

      .preview {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 14px;
        align-items: center;
      }
      .ph {
        width: 110px;
        aspect-ratio: 3/4;
        border-radius: 12px;
        background: #0f172a;
        border: 1px solid #ffffff1f;
        display: grid;
        place-items: center;
        overflow: hidden;
      }
      .ph img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .meta {
        display: grid;
        gap: 4px;
      }
      .meta small {
        color: var(--muted);
      }

      .status {
        min-height: 24px;
        font-weight: 700;
        margin-top: 4px;
      }
      .ok {
        color: var(--ok);
      }
      .err {
        color: var(--err);
      }

      footer {
        opacity: 0.8;
        text-align: center;
        font-size: 0.85rem;
        color: var(--muted);
      }

      @media (min-width: 860px) {
        .wrap {
          grid-template-columns: 420px 1fr;
          align-items: start;
        }
        .right {
          padding-left: 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="card">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Agente IA ¬∑ Esc√°ner de Albaranes</h1>
          <div class="hint">
            Sube una foto n√≠tida del documento o usa la c√°mara del m√≥vil.
          </div>
        </div>
      </header>

      <!-- Panel de carga -->
      <section class="card grid">
        <div class="pill" title="Almac√©n usado en el env√≠o">
          üè¨ <span>Almac√©n:</span> <b>Almac√©n Experiencia 43</b>
        </div>
        <div class="pill" id="pillFecha">üí≥ Fecha de pago: <b></b></div>

        <!-- Zona de arrastre/soltar + input file -->
        <label
          class="dz"
          id="dropzone"
          tabindex="0"
          aria-label="Sube o arrastra una imagen del albar√°n"
        >
          <input
            id="fileInput"
            type="file"
            name="data"
            accept="image/*"
            capture="environment"
          />
          <div>
            <div style="font-weight: 800; font-size: 1.05rem">
              Suelta una imagen aqu√≠
            </div>
            <div class="hint">o usa los botones de abajo</div>
          </div>
          <div class="cta">
            <button type="button" class="btn" id="btnCam">
              üì∑ Abrir c√°mara
            </button>
            <button type="button" class="btn sec" id="btnExplorar">
              üñºÔ∏è Elegir imagen
            </button>
          </div>
        </label>

        <!-- Vista previa -->
        <div class="preview">
          <div class="ph" id="thumb"><span class="hint">Sin imagen</span></div>
          <div class="meta">
            <div id="fileName" class="hint">‚Äî</div>
            <small id="fileInfo" class="hint"
              >Max 10MB ¬∑ Se optimiza antes de enviar</small
            >
            <div class="status" id="status"></div>
            <div class="cta">
              <button class="btn" id="btnEnviar" disabled>
                üì§ Enviar a n8n
              </button>
              <button class="btn sec" id="btnReset" disabled>‚ô∫ Limpiar</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Detalles del env√≠o / respuesta -->
      <section class="card right">
        <div class="hint" style="margin-bottom: 8px">
          Respuesta del servidor
        </div>
        <pre
          id="out"
          style="
            margin: 0;
            max-height: 280px;
            overflow: auto;
            background: #030712;
            border: 1px solid #ffffff1a;
            border-radius: 12px;
            padding: 14px;
            color: #d1d5db;
          "
        ></pre>
        <footer style="margin-top: 10px">
          Consejo: fotograf√≠a el albar√°n perpendicular, bien iluminado y
          ocupando toda la imagen.
        </footer>
      </section>
    </div>

    <script>
      (function () {
        const INPUT = document.getElementById("fileInput");
        const DZ = document.getElementById("dropzone");
        const BTN_CAM = document.getElementById("btnCam");
        const BTN_EX = document.getElementById("btnExplorar");
        const BTN_GO = document.getElementById("btnEnviar");
        const BTN_RS = document.getElementById("btnReset");
        const STATUS = document.getElementById("status");
        const OUT = document.getElementById("out");
        const THUMB = document.getElementById("thumb");
        const FILE_N = document.getElementById("fileName");
        const FILE_I = document.getElementById("fileInfo");
        const PILL_F = document.getElementById("pillFecha").querySelector("b");

        // Fecha de pago = hoy (ISO yyyy-mm-dd)
        const todayISO = new Date().toISOString().slice(0, 10);
        PILL_F.textContent = todayISO;

        // Estado local
        let fileOriginal = null;
        let fileOptimizada = null;

        // Acciones UI
        BTN_CAM.addEventListener(
          "click",
          () => INPUT.setAttribute("capture", "environment") || INPUT.click()
        );
        BTN_EX.addEventListener(
          "click",
          () => INPUT.removeAttribute("capture") || INPUT.click()
        );

        // Drag & Drop
        ["dragenter", "dragover"].forEach((ev) =>
          DZ.addEventListener(
            ev,
            (e) => {
              e.preventDefault();
              DZ.classList.add("drag");
            },
            false
          )
        );
        ["dragleave", "drop"].forEach((ev) =>
          DZ.addEventListener(
            ev,
            (e) => {
              e.preventDefault();
              DZ.classList.remove("drag");
            },
            false
          )
        );
        DZ.addEventListener("drop", (e) => {
          const f = e.dataTransfer?.files?.[0];
          if (f) handleFile(f);
        });

        // Input file
        INPUT.addEventListener("change", () => {
          const f = INPUT.files?.[0];
          if (f) handleFile(f);
        });

        BTN_RS.addEventListener("click", resetUI);

        async function handleFile(f) {
          resetUI(false);
          fileOriginal = f;
          FILE_N.textContent = f.name || "imagen";
          FILE_I.textContent = `${(f.size / 1024 / 1024).toFixed(2)} MB ¬∑ ${
            f.type || "image/*"
          }`;

          // Vista previa
          const url = URL.createObjectURL(f);
          THUMB.innerHTML = "";
          const img = document.createElement("img");
          img.src = url;
          THUMB.appendChild(img);

          // Optimizar
          try {
            STATUS.textContent = "üõ†Ô∏è Optimizando imagen...";
            fileOptimizada = await optimizarImagen(f, 1600, 0.85);
            STATUS.textContent = `‚úÖ Lista (${(
              fileOptimizada.size /
              1024 /
              1024
            ).toFixed(2)} MB)`;
            BTN_GO.disabled = false;
            BTN_RS.disabled = false;
          } catch (err) {
            console.error(err);
            STATUS.textContent = "‚ùå Error al procesar la imagen";
            STATUS.className = "status err";
          } finally {
            URL.revokeObjectURL(url);
          }
        }

        function resetUI(clearThumb = true) {
          STATUS.textContent = "";
          STATUS.className = "status";
          OUT.textContent = "";
          BTN_GO.disabled = true;
          BTN_RS.disabled = true;

          if (clearThumb) {
            THUMB.innerHTML = '<span class="hint">Sin imagen</span>';
            FILE_N.textContent = "‚Äî";
            FILE_I.textContent = "Max 10MB ¬∑ Se optimiza antes de enviar";
          }
          fileOriginal = null;
          fileOptimizada = null;
          INPUT.value = "";
        }

        // üîß Limpia valores que puedan venir con "=" desde n8n
        function cleanVal(v, fallback = "") {
          if (v == null) return fallback;
          if (typeof v === "string") {
            const t = v.trim().replace(/^=+/, "");
            return t || fallback;
          }
          return v;
        }

        // Env√≠o
        BTN_GO.addEventListener("click", submit);

        async function submit() {
          if (!fileOptimizada) return;

          BTN_GO.disabled = true;
          STATUS.textContent = "üöÄ Enviando...";

          const fd = new FormData();
          fd.append(
            "data",
            fileOptimizada,
            fileOptimizada.name || "albaran.jpg"
          );
          fd.append("almacen", "Almac√©n Experiencia 43");
          fd.append("fecha_pago", todayISO);

          try {
            const res = await fetch(
              "https://growtur.app.n8n.cloud/webhook/24f4abf0-811a-4a70-9800-c09f4bd29b64",
              { method: "POST", body: fd }
            );
            const json = await res.json().catch(() => ({}));

            let numAlb = cleanVal(json.num_albaran);
            // üîπ Solo n√∫mero del albar√°n
            if (typeof numAlb === "string") {
              const match = numAlb.match(/\d+/);
              numAlb = match ? match[0] : numAlb;
            }

            const almacen = cleanVal(json.almacen, "Almac√©n Experiencia 43");
            let li = cleanVal(json.lineas_insertadas, "‚Äî");
            if (!isNaN(Number(li))) li = String(Number(li));

            const display = {
              num_albaran: numAlb || "G-222660",
              almacen,
              lineas_insertadas: li,
            };
            OUT.textContent = JSON.stringify(display, null, 2);

            if (res.ok) {
              STATUS.textContent = `‚úÖ Albar√°n ${
                numAlb || ""
              } ¬∑ ${almacen}. L√≠neas: ${li}`;
              STATUS.className = "status ok";
            } else {
              STATUS.textContent = `‚ùå Error ${res.status}: ${
                json.message || "respuesta no v√°lida"
              }`;
              STATUS.className = "status err";
              BTN_GO.disabled = false;
            }
          } catch (err) {
            console.error(err);
            STATUS.textContent = "‚ùå Error de red. Intenta de nuevo.";
            STATUS.className = "status err";
            BTN_GO.disabled = false;
          }
        }

        // Optimizaci√≥n: redimensiona con canvas y exporta a JPEG
        function optimizarImagen(file, maxDim = 1600, quality = 0.85) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            const fr = new FileReader();

            fr.onload = () => {
              img.src = fr.result;
            };
            fr.onerror = () => reject(new Error("No se pudo leer el archivo"));
            img.onerror = () =>
              reject(new Error("No se pudo cargar la imagen"));

            img.onload = () => {
              let { width: w, height: h } = img;
              if (w > maxDim || h > maxDim) {
                if (w > h) {
                  h = Math.round((h * maxDim) / w);
                  w = maxDim;
                } else {
                  w = Math.round((w * maxDim) / h);
                  h = maxDim;
                }
              }

              const c = document.createElement("canvas");
              c.width = w;
              c.height = h;
              const ctx = c.getContext("2d", {
                alpha: false,
                desynchronized: true,
              });
              if (ctx.imageSmoothingEnabled !== undefined)
                ctx.imageSmoothingEnabled = true;
              ctx.drawImage(img, 0, 0, w, h);

              c.toBlob(
                (blob) => {
                  if (!blob) return reject(new Error("toBlob() devolvi√≥ null"));
                  const out = new File(
                    [blob],
                    (file.name || "albaran") + ".jpg",
                    {
                      type: "image/jpeg",
                      lastModified: Date.now(),
                    }
                  );
                  resolve(out);
                },
                "image/jpeg",
                quality
              );
            };

            fr.readAsDataURL(file);
          });
        }
      })();
    </script>
  </body>
</html>
