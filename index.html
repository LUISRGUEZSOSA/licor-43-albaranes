<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Escáner de Albaranes · Licor 43</title>
    <meta name="color-scheme" content="light dark" />
    <!-- Favicon -->
    <link rel="icon" href="NEGATIVO.jpg" type="image/jpeg" sizes="32x32" />
    <link rel="apple-touch-icon" href="NEGATIVO.jpg" />
    <meta name="theme-color" content="#0f172a" />

    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --card: #0b1223cc; /* glass */
        --text: #e5e7eb; /* gray-200 */
        --muted: #94a3b8; /* slate-400 */
        --brand: #f59e0b; /* amber-500 */
        --brand-2: #fde047; /* amber-300 */
        --ok: #10b981; /* emerald-500 */
        --err: #ef4444; /* red-500 */
        --ring: #22d3ee; /* cyan-400 */
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        color: var(--text);
        background: radial-gradient(
            1200px 600px at 90% -10%,
            #1e293b 10%,
            transparent 60%
          ),
          radial-gradient(900px 500px at -10% 20%, #111827 10%, transparent 60%),
          linear-gradient(180deg, #020617, #0b1223 60%, #0f172a);
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .wrap {
        width: min(100%, 980px);
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr;
      }
      header {
        display: flex;
        align-items: center;
        gap: 14px;
        justify-content: center;
      }
      .logo {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: url("logo_licor43.jpeg") center/cover no-repeat, #111827;
        box-shadow: 0 0 0 2px #ffffff22 inset, 0 10px 30px #0006;
        flex: none;
      }
      h1 {
        margin: 0;
        font-size: clamp(1.15rem, 2.5vw, 1.5rem);
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #fff;
      }

      .card {
        background: var(--card);
        backdrop-filter: blur(8px) saturate(120%);
        border: 1px solid #ffffff1f;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 30px #0006;
      }

      .grid {
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 1px solid #ffffff26;
        border-radius: 999px;
        background: #ffffff14;
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
      }
      .pill b {
        color: var(--brand-2);
      }
      .hint {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .dz {
        position: relative;
        display: grid;
        place-items: center;
        gap: 10px;
        text-align: center;
        border: 1.5px dashed #ffffff33;
        border-radius: 16px;
        padding: 22px;
        background: #0b122366;
        transition: all 0.15s ease;
        outline: none;
      }
      .dz.drag {
        border-color: var(--ring);
        box-shadow: 0 0 0 3px #22d3ee55;
      }
      .dz input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }
      .dz .cta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        appearance: none;
        border: 0;
        border-radius: 12px;
        padding: 12px 16px;
        color: #0b1223;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(180deg, var(--brand), var(--brand-2));
        box-shadow: 0 8px 20px #f59e0b3a;
        transition: transform 0.08s ease, box-shadow 0.15s ease,
          filter 0.2s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(0.1);
      }
      .btn.sec {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #ffffff24;
        box-shadow: none;
      }

      .preview {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 14px;
        align-items: center;
      }
      .ph {
        width: 110px;
        aspect-ratio: 3/4;
        border-radius: 12px;
        background: #0f172a;
        border: 1px solid #ffffff1f;
        display: grid;
        place-items: center;
        overflow: hidden;
      }
      .ph img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .meta {
        display: grid;
        gap: 4px;
      }
      .meta small {
        color: var(--muted);
      }

      .status {
        min-height: 24px;
        font-weight: 700;
        margin-top: 4px;
      }
      .ok {
        color: var(--ok);
      }
      .err {
        color: var(--err);
      }

      footer {
        opacity: 0.8;
        text-align: center;
        font-size: 0.85rem;
        color: var(--muted);
      }

      @media (min-width: 860px) {
        .wrap {
          grid-template-columns: 420px 1fr;
          align-items: start;
        }
        .right {
          padding-left: 6px;
        }
      }
      /* Footer de marca fuera de la card derecha */
      .brand-footer {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 12px;
        opacity: 0.95;
        /*padding: 60px 0;*/
        padding-block: clamp(20px, 8vw, 60px);
      }

      .brand-footer img {
        height: clamp(56px, 8vw, 88px);
        width: auto;
        border: none;
        box-shadow: none;
        border-radius: 0;
        background: transparent;
      }

      /*PATCH PARA ASEGURAR RESPONSIVIDAD*/
      /* 1) Padding global responsive */
      body {
        /* antes: padding: 24px; */
        padding: clamp(16px, 4vw, 24px);
      }

      /* 2) Vista previa más flexible */
      .preview {
        /* en móviles muy estrechos, apilar */
        grid-template-columns: 1fr;
      }
      @media (min-width: 380px) {
        .preview {
          /* miniatura más adaptable que un fijo a 110px */
          grid-template-columns: minmax(80px, 110px) 1fr;
        }
      }

      /* 3) Miniatura adaptable */
      .ph {
        /* antes: width: 110px; */
        width: clamp(80px, 28vw, 110px);
      }

      /* 4) Elipsis para nombres de archivo largos */
      #fileName {
        max-width: 100%;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* 5) Dropzone con padding responsive */
      .dz {
        /* antes: padding: 22px; */
        padding: clamp(14px, 4.5vw, 24px);
      }

      /* 6) Footer general con tipografía levemente responsive */
      footer {
        font-size: clamp(0.82rem, 1.8vw, 0.9rem);
      }

      /* 7) Botones: sin hover “saltón” en pantallas táctiles */
      @media (hover: none) {
        .btn:hover {
          transform: none;
          filter: none;
        }
      }

      /* 8) Respetar usuarios con reduce motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
          animation: none !important;
          scroll-behavior: auto !important;
        }
      }

      /* 9) Ajustes de layout en pantallas muy anchas (opcional, más aire) */
      @media (min-width: 1200px) {
        .wrap {
          gap: clamp(20px, 2vw, 32px);
        }
      }

      /*AIRE LATERAL A LOS BLOQUES */
      /* === PATCH: más aire lateral en bloques (excepto logo del footer),
   reducir ancho de la columna izquierda (card grid) y separar más entre columnas === */

      /* 1) Márgenes laterales a todos los bloques dentro de .wrap excepto el logo del footer */
      .wrap > :not(.brand-footer) {
        margin-inline: clamp(12px, 5vw, 40px);
      }

      /* 2) Un poco más de aire vertical entre bloques apilados en móvil */
      .wrap {
        row-gap: clamp(18px, 4vw, 28px);
      }

      /* 3) Desktop: reducir ancho de la columna izquierda (card grid) y aumentar la separación entre columnas */
      @media (min-width: 860px) {
        .wrap {
          /* antes: 420px 1fr */
          grid-template-columns: 360px 1fr;
          column-gap: clamp(24px, 4.5vw, 48px);
          row-gap: clamp(18px, 3vw, 28px);
        }
        /* pequeño acolchado entre la columna derecha y el borde interno */
        .right {
          padding-left: clamp(6px, 1vw, 12px);
        }
      }

      /* 4) Asegurar que el logo del footer siga a ancho completo sin márgenes laterales añadidos */
      .brand-footer {
        margin-inline: 0;
      }
      /* Caja de versión bajo el footer */
      .version-box {
        grid-column: 1 / -1;
        text-align: center;
        background: #0b1223; /* azul marino consistente con la paleta */
        color: var(--text);
        font-size: clamp(0.8rem, 1.8vw, 0.9rem);
        font-weight: 500;
        border-radius: 12px;
        padding: clamp(10px, 3vw, 14px) clamp(12px, 4vw, 20px);
        margin-top: 8px;
        opacity: 0.85;
      }

      /* --- Patch: logo más pequeño y texto más cercano --- */

      /* 1) Logo del footer ligeramente más pequeño en móviles/tablets */
      .brand-footer img {
        /* antes: clamp(40px, 12vw, 72px) */
        height: clamp(36px, 10vw, 64px);
      }

      /* 2) Footer: menos padding debajo del logo para acercar el box */
      .brand-footer {
        /* mantenemos aire arriba y compactamos abajo */
        padding-block-start: clamp(16px, 6vw, 48px);
        padding-block-end: clamp(6px, 2.5vw, 12px);
      }

      /* 3) Caja de versión: aún más cerca y compacta */
      .version-box {
        margin-top: 1px; /* antes: 4px */
        padding-block: clamp(4px, 1.6vw, 8px);
        padding-inline: clamp(10px, 3vw, 16px);
      }
      .brand-footer {
        padding-block-end: 0; /* antes tenía más aire */
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="card">
        <div class="logo" aria-hidden="true"></div>
        <div class="agente">
          <h1>Agente IA · Escáner de Albaranes</h1>
          <div class="hint">
            Sube una foto nítida del documento o usa la cámara del móvil.
          </div>
        </div>
      </header>

      <!-- Panel de carga -->
      <section class="card grid">
        <div class="pill" title="Almacén usado en el envío">
          🏬 <span>Almacén:</span> <b>Almacén Experiencia 43</b>
        </div>
        <div class="pill" id="pillFecha">💳 Fecha de entrega: <b></b></div>

        <!-- Zona de arrastre/soltar + inputs separados -->
        <label
          class="dz"
          id="dropzone"
          tabindex="0"
          aria-label="Sube o arrastra una imagen del albarán"
        >
          <!-- Inputs separados para máxima compatibilidad móvil -->
          <input
            id="fileCamera"
            type="file"
            accept="image/*"
            capture="environment"
            style="display: none"
          />
          <input
            id="filePicker"
            type="file"
            accept="image/*"
            style="display: none"
          />

          <div>
            <div style="font-weight: 800; font-size: 1.05rem">
              Suelta una imagen aquí
            </div>
            <div class="hint">o usa los botones de abajo</div>
          </div>
          <div class="cta">
            <button type="button" class="btn" id="btnCam">📷 Hacer foto</button>
            <button type="button" class="btn sec" id="btnExplorar">
              🖼️ Subir imagen
            </button>
          </div>
        </label>

        <!-- Vista previa -->
        <div class="preview">
          <div class="ph" id="thumb"><span class="hint">Sin imagen</span></div>
          <div class="meta">
            <div id="fileName" class="hint">—</div>
            <small id="fileInfo" class="hint"
              >Max 10MB · Se optimiza antes de enviar</small
            >
            <div class="status" id="status"></div>
            <div class="cta">
              <button class="btn" id="btnEnviar" disabled>📤 Enviar</button>
              <button class="btn sec" id="btnReset" disabled>♺ Limpiar</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Detalles del envío / respuesta -->
      <section class="card right">
        <div class="hint" style="margin-bottom: 8px">
          Respuesta del servidor
        </div>
        <pre
          id="out"
          style="
            margin: 0;
            max-height: 280px;
            overflow: auto;
            background: #030712;
            border: 1px solid #ffffff1a;
            border-radius: 12px;
            padding: 14px;
            color: #d1d5db;
          "
        ></pre>
        <footer style="margin-top: 10px">
          <div>
            Consejo: fotografía nítida, buena iluminación y albarán ocupando
            toda la imagen.
          </div>
        </footer>
      </section>

      <div class="brand-footer">
        <img src="bygrowtur.png" alt="Licor 43" loading="lazy" />
      </div>
      <div class="version-box">
        Agente IA · Escáner de Albaranes versión&nbsp;1.0
      </div>
    </div>

    <script>
      const N8N_UPLOAD_URL =
        "https://growtur.app.n8n.cloud/webhook/upload-image"; // tu URL prod

      (function () {
        const INPUT_CAM = document.getElementById("fileCamera");
        const INPUT_PICK = document.getElementById("filePicker");
        const DZ = document.getElementById("dropzone");
        const BTN_CAM = document.getElementById("btnCam");
        const BTN_EX = document.getElementById("btnExplorar");
        const BTN_GO = document.getElementById("btnEnviar");
        const BTN_RS = document.getElementById("btnReset");
        const STATUS = document.getElementById("status");
        const OUT = document.getElementById("out");
        const THUMB = document.getElementById("thumb");
        const FILE_N = document.getElementById("fileName");
        const FILE_I = document.getElementById("fileInfo");
        const PILL_F = document.getElementById("pillFecha").querySelector("b");

        // Fecha de pago = hoy (ISO yyyy-mm-dd)
        const todayISO = new Date().toISOString().slice(0, 10);
        PILL_F.textContent = todayISO;

        // Estado local
        let fileOriginal = null;
        let fileOptimizada = null;

        // Botones → cada uno abre su input correspondiente
        BTN_CAM.addEventListener("click", () => INPUT_CAM.click());
        BTN_EX.addEventListener("click", () => INPUT_PICK.click());

        // Lectura de archivos
        INPUT_CAM.addEventListener("change", () => {
          const f = INPUT_CAM.files?.[0];
          if (f) handleFile(f);
          INPUT_CAM.value = "";
        });
        INPUT_PICK.addEventListener("change", () => {
          const f = INPUT_PICK.files?.[0];
          if (f) handleFile(f);
          INPUT_PICK.value = "";
        });

        // Drag & Drop
        ["dragenter", "dragover"].forEach((ev) =>
          DZ.addEventListener(
            ev,
            (e) => {
              e.preventDefault();
              DZ.classList.add("drag");
            },
            false
          )
        );
        ["dragleave", "drop"].forEach((ev) =>
          DZ.addEventListener(
            ev,
            (e) => {
              e.preventDefault();
              DZ.classList.remove("drag");
            },
            false
          )
        );
        DZ.addEventListener("drop", (e) => {
          const f = e.dataTransfer?.files?.[0];
          if (f) handleFile(f);
        });

        BTN_RS.addEventListener("click", resetUI);

        async function handleFile(f) {
          resetUI(false);
          fileOriginal = f;
          FILE_N.textContent = f.name || "imagen";
          FILE_I.textContent = `${(f.size / 1024 / 1024).toFixed(2)} MB · ${
            f.type || "image/*"
          }`;

          // Vista previa
          const url = URL.createObjectURL(f);
          THUMB.innerHTML = "";
          const img = document.createElement("img");
          img.src = url;
          THUMB.appendChild(img);

          // Optimizar
          try {
            STATUS.textContent = "🛠️ Optimizando imagen...";
            fileOptimizada = await optimizarImagen(f, 1600, 0.85);
            STATUS.textContent = `✅ Lista (${(
              fileOptimizada.size /
              1024 /
              1024
            ).toFixed(2)} MB)`;
            BTN_GO.disabled = false;
            BTN_RS.disabled = false;
          } catch (err) {
            console.error(err);
            STATUS.textContent = "❌ Error al procesar la imagen";
            STATUS.className = "status err";
          } finally {
            URL.revokeObjectURL(url);
          }
        }

        function resetUI(clearThumb = true) {
          STATUS.textContent = "";
          STATUS.className = "status";
          OUT.textContent = "";
          BTN_GO.disabled = true;
          BTN_RS.disabled = true;

          if (clearThumb) {
            THUMB.innerHTML = '<span class="hint">Sin imagen</span>';
            FILE_N.textContent = "—";
            FILE_I.textContent = "Max 10MB · Se optimiza antes de enviar";
          }
          fileOriginal = null;
          fileOptimizada = null;
          // Limpiamos ambos inputs por si acaso
          if (INPUT_CAM) INPUT_CAM.value = "";
          if (INPUT_PICK) INPUT_PICK.value = "";
        }

        // 🔧 Limpia valores que puedan venir con "=" desde n8n
        function cleanVal(v, fallback = "") {
          if (v == null) return fallback;
          if (typeof v === "string") {
            const t = v.trim().replace(/^=+/, "");
            return t || fallback;
          }
          return v;
        }

        // Envío
        BTN_GO.addEventListener("click", submit);

        async function submit() {
          if (!fileOptimizada) return;

          BTN_GO.disabled = true;
          STATUS.textContent = "🚀 Subiendo imagen...";

          // Sugerencia: nombre limpio + timestamp
          const ts = new Date()
            .toISOString()
            .replace(/[-:T.Z]/g, "")
            .slice(0, 14); // yyyyMMddHHmmss
          const safeName = (fileOptimizada.name || "albaran.jpg").replace(
            /\s+/g,
            "_"
          );
          const finalName = `${ts}_${safeName}`;

          // Importante: el Webhook espera el binario en el campo "data"
          const fd = new FormData();
          fd.append("data", fileOptimizada, finalName);

          // Puedes seguir enviando metadatos; si los quieres usar en n8n, añade un "Set" antes de subir
          fd.append("almacen", "Almacén Experiencia 43");
          fd.append("fecha_pago", todayISO);
          fd.append("filename", finalName); // así lo mapeas fácil en n8n si quieres

          try {
            const res = await fetch(N8N_UPLOAD_URL, {
              method: "POST",
              body: fd,
            });

            // Tu workflow responde con JSON { ok, id, name, webViewLink }
            const json = await res.json().catch(() => ({}));

            if (res.ok) {
              OUT.textContent = "Tu albarán ha sido procesado correctamente";
              STATUS.textContent = "✅ Subida correctamente";
              STATUS.className = "status ok";
              BTN_RS.disabled = false;
            } else {
              // En error, mostramos información mínima para depurar
              const text = await res.text().catch(() => "");
              STATUS.textContent = `❌ Error ${res.status || ""}`;
              STATUS.className = "status err";
              OUT.textContent =
                text || "Se produjo un error al procesar el albarán.";
              BTN_GO.disabled = false;
            }
          } catch (err) {
            console.error(err);
            STATUS.textContent = "❌ Error de red. Intenta de nuevo.";
            STATUS.className = "status err";
            OUT.textContent = "No se pudo conectar con el servidor.";
            BTN_GO.disabled = false;
          }
        }

        // Optimización: redimensiona con canvas y exporta a JPEG
        function optimizarImagen(file, maxDim = 1600, quality = 0.85) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            const fr = new FileReader();

            fr.onload = () => {
              img.src = fr.result;
            };
            fr.onerror = () => reject(new Error("No se pudo leer el archivo"));
            img.onerror = () =>
              reject(new Error("No se pudo cargar la imagen"));

            img.onload = () => {
              let { width: w, height: h } = img;
              if (w > maxDim || h > maxDim) {
                if (w > h) {
                  h = Math.round((h * maxDim) / w);
                  w = maxDim;
                } else {
                  w = Math.round((w * maxDim) / h);
                  h = maxDim;
                }
              }

              const c = document.createElement("canvas");
              c.width = w;
              c.height = h;
              const ctx = c.getContext("2d", {
                alpha: false,
                desynchronized: true,
              });
              if (ctx.imageSmoothingEnabled !== undefined)
                ctx.imageSmoothingEnabled = true;
              ctx.drawImage(img, 0, 0, w, h);

              c.toBlob(
                (blob) => {
                  if (!blob) return reject(new Error("toBlob() devolvió null"));
                  const out = new File(
                    [blob],
                    (file.name || "albaran") + ".jpg",
                    {
                      type: "image/jpeg",
                      lastModified: Date.now(),
                    }
                  );
                  resolve(out);
                },
                "image/jpeg",
                quality
              );
            };

            fr.readAsDataURL(file);
          });
        }
      })();
    </script>
  </body>
</html>
